<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Build your own library to render json response in Phoenix</title>
<meta name=author content="Dung Nguyen"><meta name=description content="  OnPoint is the largest E-commerce enabler in Vietnam, providing end-to-end services, helping brands to accelerate and become more successful online in Vietnam and SEA region  "><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><link rel=icon href=https://techblog.onpoint.vn/images/favicon.png type=image/x-icon><link rel=preconnect href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&amp;display=swap"><link rel=stylesheet href=https://techblog.onpoint.vn/css/vendor.min.a175996d51c7122a7871164dca713adc582e8df8a6b31ae1e7169ca0559953614b9378e577a3ce6d3e6bc8fa87b3e4f38305c3f1478fb0b4904d66b4caffe85a.css media=screen><script async src="https://www.googletagmanager.com/gtag/js?id=G-S0MXF6F38B"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S0MXF6F38B")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-S0MXF6F38B"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S0MXF6F38B")}</script></head><body><div style="min-height:calc(100vh - 65px)"><div class=header-height-fix></div><header class=header-nav><div class=container><div class=row><div class=col-12><nav class="navbar navbar-expand-lg navbar-light p-0"><a class="navbar-brand font-weight-bold mr-0" href=https://techblog.onpoint.vn/><img loading=lazy src=https://techblog.onpoint.vn/images/logo.png alt="OnPoint Tech Blog" height=35px>
</a><button class="search-toggle d-inline-block d-lg-none ml-auto mr-3" data-toggle=search aria-label="Search Toggle">
<i data-eva=search-outline></i>
</button>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navHeader aria-controls=navHeader aria-expanded=false aria-label="Toggle navigation">
<i data-eva=menu-outline></i>
<i class=d-none data-eva=close-outline></i></button><div class="collapse navbar-collapse" id=navHeader><ul class="navbar-nav mx-auto"><li class=nav-item><a class=nav-link href=https://techblog.onpoint.vn/>Blog</a></li><li class=nav-item><a class=nav-link href=https://techblog.onpoint.vn/tags/>Tags</a></li><li class=nav-item><a class=nav-link href=https://techblog.onpoint.vn/about>About us</a></li><li class=nav-item><a class=nav-link href=https://www.onpoint.vn/careers/>We are hiring</a></li></ul><div class="navbar-right d-none d-lg-inline-block"><ul class="social-links list-unstyled list-inline"><li class="list-inline-item ml-4 d-none d-lg-inline-block"><button class=search-toggle data-toggle=search aria-label="Search Toggle">
<i data-eva=search-outline></i></button></li></ul></div></div></nav></div></div></div></header><div class=search-block><div data-toggle=search-close><i data-eva=close-outline class=text-primary></i></div><form action=/search><input id=search-query name=s type=search placeholder="Type words & hit enter" class=text-center aria-label=search-query></form></div><section class=section-sm><div class=container><div class="row justify-content-center"><div class=col-lg-10><div class=pr-lg-4><div class=single-post><div class="text-center mb-5"><h1 class="mb-4 post-title">Build your own library to render json response in Phoenix</h1><ul class="card-meta list-inline"><li class=list-inline-item><a href=#! class=card-meta-author><a href=https://techblog.onpoint.vn/author/dung-nguyen/ class=card-meta-author><img loading=lazy src=https://techblog.onpoint.vn/images/author/dung-nguyen.jpg alt="Dung Nguyen">
<span>Dung Nguyen</span></a></a></li><li class=list-inline-item>|</li><li class=list-inline-item><span>23 July 2021</span></li></ul></div><div class="mb-5 text-center"><img loading=lazy class="img-fluid rounded" src=https://techblog.onpoint.vn/img/build-a-json-view.png alt="Image not Found"></div><div class=content><p>In my previous article, I introduced my library call <code>JsonView</code> to render json response easier. You can read it here:
<a href=/blog/2021-07-10-render-response-json-view>Render Ecto schema to json with relationships with JsonView</a></p><p>Today I will guide you to write your own Json render view. Let&rsquo;s start.</p><p>Now for example I have a Blog app with <code>User</code> <code>Category</code> , <code>Post</code> and <code>Comment</code> schemas.</p><p>This is <code>PostView</code> which is generated by <code>Phoenix</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>defmodule</span> <span style=color:#50fa7b>MyBlogWeb.PostView</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>use</span> <span style=color:#50fa7b>MyBlogWeb</span>, <span style=color:#f1fa8c>:view</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#ff79c6>alias</span> <span style=color:#50fa7b>MyBlogWeb.PostView</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;index.json&#34;</span>, %{<span style=color:#f1fa8c>posts</span>: posts}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    %{<span style=color:#f1fa8c>data</span>: render_many(posts, <span style=color:#50fa7b>PostView</span>, <span style=color:#f1fa8c>&#34;post.json&#34;</span>)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;show.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    %{<span style=color:#f1fa8c>data</span>: render_one(post, <span style=color:#50fa7b>PostView</span>, <span style=color:#f1fa8c>&#34;post.json&#34;</span>)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    %{<span style=color:#f1fa8c>id</span>: post<span style=color:#ff79c6>.</span>id,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#f1fa8c>title</span>: post<span style=color:#ff79c6>.</span>title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#f1fa8c>description</span>: post<span style=color:#ff79c6>.</span>description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#f1fa8c>content</span>: post<span style=color:#ff79c6>.</span>content,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#f1fa8c>cover</span>: post<span style=color:#ff79c6>.</span>cover,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>      <span style=color:#f1fa8c>is_published</span>: post<span style=color:#ff79c6>.</span>is_published}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p><strong>Let&rsquo;s improve it</strong></p><h3 id=1-use-maptake>1. Use <code>Map.take</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>		<span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>take(post, [<span style=color:#f1fa8c>:id</span>, <span style=color:#f1fa8c>:title</span>, <span style=color:#f1fa8c>:description</span>, <span style=color:#f1fa8c>:content</span>, <span style=color:#f1fa8c>:cover</span>, <span style=color:#f1fa8c>:is_published</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>...
</span></span></code></pre></div><p>This way you don&rsquo;t have to write much code every time you add a new attribute.</p><h3 id=2-render-custom-field>2. Render custom field</h3><p>You may want to:</p><ul><li>Format some field value instead of return original value</li><li>Calculate virtual field</li></ul><p>Normally you will do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>	<span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    post
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>take([<span style=color:#f1fa8c>:id</span>, <span style=color:#f1fa8c>:title</span>, <span style=color:#f1fa8c>:description</span>, <span style=color:#f1fa8c>:content</span>, <span style=color:#f1fa8c>:cover</span>, <span style=color:#f1fa8c>:is_published</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(%{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#f1fa8c>comment_count</span>: render_comment_count(post),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#f1fa8c>author_name</span>: render_author_name(post)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render_comment_count(post) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  	...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render_author_name(post) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>Or you can reduce a bit of code by using pattern matching to render custom field value</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>	<span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    post
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>take([<span style=color:#f1fa8c>:id</span>, <span style=color:#f1fa8c>:title</span>, <span style=color:#f1fa8c>:description</span>, <span style=color:#f1fa8c>:content</span>, <span style=color:#f1fa8c>:cover</span>, <span style=color:#f1fa8c>:is_published</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(render_custom_fields(post, [<span style=color:#f1fa8c>:comment_count</span>, <span style=color:#f1fa8c>:author_name</span>]))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_custom_fields(struct, fields) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>map(fields, <span style=color:#ff79c6>fn</span> field <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    	{field, render_field(field, struct)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>end</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>into(%{})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_field(<span style=color:#f1fa8c>:comment_count</span>, post) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_field(<span style=color:#f1fa8c>:author_name</span>, post) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>Now every time you add a new custom field, just add field name to the list, and define a <code>render_field/2</code> function</p><h3 id=3-render-relation-ship>3. Render relation ship</h3><p>You may want to return the whole object of author. For example you have a view <code>UserView</code> so you can do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span> <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    post
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(%{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      <span style=color:#f1fa8c>author</span>: render_one(post<span style=color:#ff79c6>.</span>author, <span style=color:#50fa7b>MyBlogWeb.UserView</span>, <span style=color:#f1fa8c>&#34;user.json&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span> <span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>It requires that author must be loaded, if not, you will get this error</p><pre tabindex=0><code>** (KeyError) key :id not found in: #Ecto.Association.NotLoaded&lt;association :author is not loaded&gt;
</code></pre><p>You can handle it by pattern matching against <code>Ecto.Association.NotLoaded</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span> <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    post
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(%{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#f1fa8c>author</span>: render_relationship(post<span style=color:#ff79c6>.</span>author, <span style=color:#50fa7b>MyBlogWeb.UserView</span>, <span style=color:#f1fa8c>&#34;user.json&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span> <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span> <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(%<span style=color:#50fa7b>Ecto.Association.NotLoaded</span>{}, _, _), <span style=color:#f1fa8c>do</span>: nil
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span> <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(relation, view, template) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    render_one(relation, view, template)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span> <span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>And it only render relations struct if loaded, otherwise it is set to nil.</p><p>Now you can improve it to render list of relationships</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    post
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      render_relationship(post, [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        {<span style=color:#f1fa8c>:author</span>, <span style=color:#50fa7b>MyBlogWeb.UserView</span>, <span style=color:#f1fa8c>&#34;user.json&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        {<span style=color:#f1fa8c>:comments</span>, <span style=color:#50fa7b>MyBlogWeb.CommentView</span>, <span style=color:#f1fa8c>&#34;comment.json&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      ])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(struct, relationships) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>map(relationships, <span style=color:#ff79c6>fn</span> {field, view, template} <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      {field, render_relationship(<span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>get(struct, field), view, template)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>end</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>into(%{})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(%<span style=color:#50fa7b>Ecto.Association.NotLoaded</span>{}, _, _), <span style=color:#f1fa8c>do</span>: nil
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(relations, view, template) <span style=color:#ff79c6>when</span> is_list(relations) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    render_many(relations, view, template)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(relation, view, template) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    render_one(relation, view, template)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>With this way you can handle both single struct and list of struct.</p><h3 id=4-combines-these-helper-functions>4. Combines these helper functions</h3><p>You can combine them all in one function and only need to pass field definition to this function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#50fa7b>@fields</span> [<span style=color:#f1fa8c>:id</span>, <span style=color:#f1fa8c>:title</span>, <span style=color:#f1fa8c>:description</span>, <span style=color:#f1fa8c>:content</span>, <span style=color:#f1fa8c>:cover</span>, <span style=color:#f1fa8c>:is_published</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#50fa7b>@custom_fiels</span> [<span style=color:#f1fa8c>:comment_count</span>, <span style=color:#f1fa8c>:author_name</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#50fa7b>@relationships</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {<span style=color:#f1fa8c>:author</span>, <span style=color:#50fa7b>MyBlogWeb.UserView</span>, <span style=color:#f1fa8c>&#34;user.json&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {<span style=color:#f1fa8c>:comments</span>, <span style=color:#50fa7b>MyBlogWeb.CommentView</span>, <span style=color:#f1fa8c>&#34;comment.json&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    render_json(post, <span style=color:#50fa7b>@fields</span>, <span style=color:#50fa7b>@custom_fiels</span>, <span style=color:#50fa7b>@relationships</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render_json(struct, fields, custom_fields \\ [], relationships \\ []) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    struct
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>take(fields)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(render_custom_fields(struct, custom_fields))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(render_relationship(struct, relationships))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#ff79c6>end</span>
</span></span></code></pre></div><h2 id=move-them-to-a-helper>Move them to a helper</h2><p>These functions are the same for every view, so let&rsquo;s move these code to a helper module <code>JsonViewHelper</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>defmodule</span> <span style=color:#50fa7b>JsonViewHelper</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#ff79c6>import</span> <span style=color:#50fa7b>Phoenix.View</span>, <span style=color:#f1fa8c>only</span>: [<span style=color:#f1fa8c>render_one</span>: <span style=color:#bd93f9>3</span>, <span style=color:#f1fa8c>render_many</span>: <span style=color:#bd93f9>3</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render_json(struct, view, fields, custom_fields \\ [], relationships \\ []) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    struct
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>take(fields)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(render_custom_fields(struct, view, custom_fields))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>merge(render_relationship(struct, relationships))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_custom_fields(struct, view, fields) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>map(fields, <span style=color:#ff79c6>fn</span> field <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      {field, view<span style=color:#ff79c6>.</span>render_field(field, struct)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>end</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>into(%{})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(struct, relationships) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>map(relationships, <span style=color:#ff79c6>fn</span> {field, view, template} <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      {field, render_relationship(<span style=color:#50fa7b>Map</span><span style=color:#ff79c6>.</span>get(struct, field), view, template)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>end</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>|&gt;</span> <span style=color:#50fa7b>Enum</span><span style=color:#ff79c6>.</span>into(%{})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(%<span style=color:#50fa7b>Ecto.Association.NotLoaded</span>{}, _, _), <span style=color:#f1fa8c>do</span>: nil
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(relations, view, template) <span style=color:#ff79c6>when</span> is_list(relations) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    render_many(relations, view, template)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>  <span style=color:#8be9fd;font-style:italic>defp</span> render_relationship(relation, view, template) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    render_one(relation, view, template)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></div><p>Here I modify <code>render_custom_fields</code> a bit, because we call <code>render_field</code> to render custom field, so we have pass the view module as second parameter, so we can use the module to invoke those <code>render_field</code> that we define.</p><p>And now render json response is much simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>defmodule</span> <span style=color:#50fa7b>BlogeeWeb.PostView</span> <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#50fa7b>@fields</span> [<span style=color:#f1fa8c>:id</span>, <span style=color:#f1fa8c>:title</span>, <span style=color:#f1fa8c>:description</span>, <span style=color:#f1fa8c>:content</span>, <span style=color:#f1fa8c>:cover</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#50fa7b>@custom_fields</span> [<span style=color:#f1fa8c>:status</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#50fa7b>@relationships</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {<span style=color:#f1fa8c>:author</span>, <span style=color:#50fa7b>BlogeeWeb.UserView</span>, <span style=color:#f1fa8c>&#34;basic_info.json&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {<span style=color:#f1fa8c>:category</span>, <span style=color:#50fa7b>BlogeeWeb.CategoryView</span>, <span style=color:#f1fa8c>&#34;category.json&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render(<span style=color:#f1fa8c>&#34;post.json&#34;</span>, %{<span style=color:#f1fa8c>post</span>: post}) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#50fa7b>JsonViewHelper</span><span style=color:#ff79c6>.</span>render_json(post, __MODULE__, <span style=color:#50fa7b>@fields</span>, <span style=color:#50fa7b>@custom_fields</span>, <span style=color:#50fa7b>@relationships</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#8be9fd;font-style:italic>def</span> render_field(<span style=color:#f1fa8c>:status</span>, post) <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> post<span style=color:#ff79c6>.</span>is_published <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#f1fa8c>&#34;published&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#f1fa8c>&#34;draft&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></div><h2 id=hooray>Hooray</h2><p>Thank you for reading to the end of this article. Hope that this can help.
If you want to use render hook, take a look at my github for full code</p><p><a href=https://github.com/bluzky/json_view>https://github.com/bluzky/json_view</a></p></div></div><div class=single-post-meta><div class="row justify-content-center"><div class="col-md-6 text-center text-md-left"><ul class="post-meta-tags list-unstyled list-inline"><li class=list-inline-item><a href=https://techblog.onpoint.vn/tags/elixir>#elixir</a></li><li class=list-inline-item><a href=https://techblog.onpoint.vn/tags/phoenix>#phoenix</a></li><li class=list-inline-item><a href=https://techblog.onpoint.vn/tags/json-view>#json view</a></li></ul></div><div class="col-md-6 text-center text-md-right mt-4 mt-md-0"><ul class="social-links has-bg-color list-unstyled list-inline" style=line-height:0><li class=list-inline-item><a class="resp-sharing-button__link d-block" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftechblog.onpoint.vn%2fblog%2f2021-07-23-build-a-json-view-yourself%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><i data-eva=facebook-outline class=text-dark></i></div></div></a></li><li class=list-inline-item><a class="resp-sharing-button__link d-block" href="https://twitter.com/intent/tweet/?text=Build%20your%20own%20library%20to%20render%20json%20response%20in%20Phoenix&amp;url=https%3a%2f%2ftechblog.onpoint.vn%2fblog%2f2021-07-23-build-a-json-view-yourself%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><i data-eva=twitter-outline class=text-dark></i></div></div></a></li></ul></div></div></div><div class=single-post-author><div class="row justify-content-center"><div class=col-md-12><div class="media d-block d-sm-flex text-center text-sm-left"><a href=https://techblog.onpoint.vn/author/dung-nguyen/><img loading=lazy class="img-fluid rounded-circle mr-0 mr-sm-4 mb-4" src=https://techblog.onpoint.vn/images/author/dung-nguyen.jpg alt="Dung Nguyen"></a><div class=media-body><h4><a href=https://techblog.onpoint.vn/author/dung-nguyen/ class="text-dark font-weight-700">Dung Nguyen</a></h4><p class=font-primary>Hi! I&rsquo;m Dung Nguyen. I&rsquo;m an Elixir developer at OnPoint Vietnam.</p><ul class="social-links list-unstyled list-inline ml-0 ml-sm-n2"><li class=list-inline-item><a href=https://www.linkedin.com/in/dung-nguyen-tien-695ba135/><i class="lab linkedin-outline"></i></a></li><li class=list-inline-item><a href=https://www.github.com/bluzky><i class="lab github-outline"></i></a></li><li class=list-inline-item><a href=https://dev.to/bluzky><i class="lab book-outline"></i></a></li></ul></div></div></div></div></div><div class=single-post-similer><div class="row justify-content-center"><div class=col-md-12><div class="row mt-3"><div class=col-12><h3 class="text-dark font-weight-800 mb-4 pb-2">You May Also Like</h3></div><div class=col-md-6><article class="card post-card"><a href=https://techblog.onpoint.vn/blog/2021-07-10-render-response-json-view/><img loading=lazy class="w-100 rounded" src=https://techblog.onpoint.vn/img/json-view.png alt="Elixir phoenix - Render Ecto schema to json with relationships"></a><div class=card-body><ul class="card-meta list-inline mb-2"><li class="list-inline-item mb-2"><a href=https://techblog.onpoint.vn/author/dung-nguyen/ class=card-meta-author><img loading=lazy src=https://techblog.onpoint.vn/images/author/dung-nguyen.jpg alt="Dung Nguyen">
<span>Dung Nguyen</span></a></li><li class="list-inline-item mb-2"><span>10 Jul, 2021</span></li></ul><h3 class=mb-3><a class=post-title href=https://techblog.onpoint.vn/blog/2021-07-10-render-response-json-view/>Elixir phoenix - Render Ecto schema to json with relationships</a></h3><p>When writing API with Phoenix and render json to client,
For some fields I want to keep it original value. For some fields, I want to do some …</p><ul class="card-meta list-inline"><li class="list-inline-item mb-2"><ul class="card-meta-tag list-inline"><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/elixir>elixir</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/phoenix>phoenix</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/json-view>json view</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/ecto>ecto</a></li></ul></li></ul></div></article></div><div class=col-md-6><article class="card post-card"><a href=https://techblog.onpoint.vn/blog/2020-10-30-compose-ecto-query-from-client/><img loading=lazy class="w-100 rounded" src=https://techblog.onpoint.vn/img/request-to-query.png alt="Compose Ecto Query From Client"></a><div class=card-body><ul class="card-meta list-inline mb-2"><li class="list-inline-item mb-2"><a href=https://techblog.onpoint.vn/author/dung-nguyen/ class=card-meta-author><img loading=lazy src=https://techblog.onpoint.vn/images/author/dung-nguyen.jpg alt="Dung Nguyen">
<span>Dung Nguyen</span></a></li><li class="list-inline-item mb-2"><span>30 Oct, 2020</span></li></ul><h3 class=mb-3><a class=post-title href=https://techblog.onpoint.vn/blog/2020-10-30-compose-ecto-query-from-client/>Compose Ecto Query From Client</a></h3><p>The story At our company, OnPoint, we are building an ecommerce website using Phoenix Framework. And I am working on admin to manage product, orders …</p><ul class="card-meta list-inline"><li class="list-inline-item mb-2"><ul class="card-meta-tag list-inline"><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/elixir>elixir</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/phoenix>phoenix</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/query>query</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/ecto>ecto</a></li><li class="list-inline-item tag"><a href=https://techblog.onpoint.vn/tags/querie>querie</a></li></ul></li></ul></div></article></div></div></div></div></div></div></div></div></div></section></div><footer class="section-sm p-0"><div class=container><div class="row justify-content-center align-items-center"><div class=col-lg-5></div><div class="col-lg-12 text-center mb-3"><ul class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3"></ul><p class="mb-0 font-weight-500 copyright-text content">Blog by OnPoint Team. Theme by <a href=https://gethugothemes.com/>Gethugothemes</a></p></div></div></div></footer><script src=https://unpkg.com/eva-icons></script><script data-turbolinks-suppress-warning src=/js/vendor.min.b47a3989ae879685fa4c118afdf8e65b74660e3f9c3b6557a83a4c54e1cf64c04ac6127c4d1984ae0cd985b8b3c91bda5558bf338b5ae4784ea91de132ccbb7a.js></script></body></html>